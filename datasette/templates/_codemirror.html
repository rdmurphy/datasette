<style>
  .cm-editor {
    resize: both;
    overflow: hidden;
    width: 80%;
    border: 1px solid #ddd;
  }
  /* Fix autocomplete icon positioning. The icon element gets border-box sizing set due to
     the global reset, but this causes overlapping icon and text. Markup:
     `<div class="cm-completionIcon cm-completionIcon-keyword" aria-hidden="true"></div>` */
  .cm-completionIcon {
    box-sizing: content-box;
  }
</style>
<script type="module">
  import "{{ base_url }}-/static/sql-formatter-2.3.3.min.js";
  import * as cm from "{{ base_url }}-/static/cm-editor-6.0.1.bundle.js";


  {% if table_columns %}
  const schema = {{ table_columns|tojson(2) }};
  {% else %}
  const schema = {};
  {% endif %}

  window.addEventListener("DOMContentLoaded", () => {
    const sqlFormat = document.querySelector("button#sql-format");
    const readOnly = document.querySelector("pre#sql-query");
    const sqlInput = document.querySelector("textarea#sql-editor");
    if (sqlFormat && !readOnly) {
      sqlFormat.hidden = false;
    }
    if (sqlInput) {
      var editor = (window.editor = cm.editorFromTextArea(sqlInput, {
        schema,
      }));
      if (sqlFormat) {
        sqlFormat.addEventListener("click", (ev) => {
          const formatted = sqlFormatter.format(editor.state.doc.toString());
          editor.dispatch({
            changes: {
              from: 0,
              to: editor.state.doc.length,
              insert: formatted,
            },
          });
        });
      }
    }
    if (sqlFormat && readOnly) {
      const formatted = sqlFormatter.format(readOnly.innerHTML);
      if (formatted != readOnly.innerHTML) {
        sqlFormat.hidden = false;
        sqlFormat.addEventListener("click", (ev) => {
          readOnly.innerHTML = formatted;
        });
      }
    }
  });
</script>

